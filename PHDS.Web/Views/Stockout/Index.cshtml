@model IEnumerable<PHDS.Web.Models.StockoutModels.StockoutOrder>
@{
    var orders = Newtonsoft.Json.JsonConvert.SerializeObject(Model, new Newtonsoft.Json.Converters.IsoDateTimeConverter { DateTimeFormat = "yyyy/MM/dd" });
}

@{
    ViewBag.Title = "发货 - 进销存系统";
}

@section styles{
    @Styles.Render("~/Content/DataTables/css/datatables")
    <style>
        body {
            overflow-y: scroll;
        }

        .table#orders {
            font-size: 12px;
            margin-top: 0px !important;
            margin-bottom: 0px !important;
        }

        .table#details {
            font-size: 12px;
        }

        tr.active > td {
            background-color: #0075b0 !important;
            color: #fff;
        }
    </style>
}

<div class="row">
    <div class="col-xs-4 col-sm-3 col-md-2 col-lg-1">
            <a href="@Url.Action("Create")" class="btn btn-danger btn-block btn-flat"><i class="fa fa-plus"></i>　新增</a>
    </div>
    <div class="col-xs-8 col-sm-7 col-md-5 col-lg-3 pull-right">
        <div class="input-group">
            <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
            <input type="text" class="form-control" aria-label="..." id="filter">
            <div class="input-group-btn">
                <button type="button" class="btn btn-primary btn-flat dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">筛选 <span class="caret"></span></button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <li><a href="#">销售送货</a></li>
                    <li><a href="#">委外送货</a></li>
                    <li><a href="#">Something else here</a></li>
                    <li role="separator" class="divider"></li>
                    <li><a href="#">Separated link</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div style="margin: 10px auto;"></div>
<div class="box box-primary">
    <div class="box-header with-border">
        <h3 class="box-title">Stock Out</h3>
        <div class="box-tools pull-right">
            <!-- Buttons, labels, and many other things can be placed here! -->
            <!-- Here is a label for example -->
            <span class="label label-danger"></span>
            <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
        </div><!-- /.box-tools -->
    </div><!-- /.box-header -->
    <div class="box-body">
        <table id="orders" class="table table-hover table-bordered table-striped">
            <thead></thead>
            <tbody></tbody>
            <tfoot>
                <tr></tr>
            </tfoot>
        </table>
    </div><!-- /.box-body -->
</div><!-- /.box -->
<div class="box box-warning">
    <div class="box-header with-border">
        <h3 class="box-title">Stock Out Details</h3>
    </div>
    <div class="box-body">
        <table class="table table-bordered table-striped table-hover" id="details"></table>
    </div>
</div>

@section scripts{
    @Scripts.Render("~/Scripts/DataTables/datatables")

    <script>
        var json = @(new MvcHtmlString(orders));

        for(var item in json)
        {
            json[item].stockoutAmount = json[item].stockoutAmount.toFixed(2);
            json[item].stockoutSquare = json[item].stockoutSquare.toFixed(2);
        }

        $.extend(true, $.fn.DataTable.defaults ,CONSTANT.DATA_TABLES.DEFAULT_OPTION);

        thisTable = $('#orders').DataTable({
            searching:true,
            dom:'rtip',
            data: json,
            columns:
                [
                    { data: "itemsCount" , title: "项数", width:"3em", className:"text-center", render:function (data, type, row, meta){return "<span class='badge'>"+ row.itemsCount +"</span>"}},
                    { data: "customerId", title: "客户编号", width: "7em", visible: false },
                    { data: "orderId", title: "单据", width: "15em", render:function (data, type, row, meta){return data + " - "+ row.stockoutDate}},
                    { data: "stockoutDate", title: "送货日期", width: "7em", visible:false, },
                    { data: "customerName", title: "客户", width: "10em", },
                    //{ data: "customerAddress" , title: "地址", },
                    { data: "stockoutComment", title: "备注", width: "auto", visible: true, },
                    { data: "stockoutType", title: "业务类型", width: "6em", visible: false },
                    { data: "stockoutTypeDescription", title: "业务类型", width: "10em", visible: true, render:function (data, type, row, meta){return data + " - " + row.stockoutType} },
                    { data: "stockoutSquare", title: "面积", width:"6em", className: "text-right", @*render: function (data, type, row, meta) { return "<span class='badge'>" + data + "</span>" }*@ },
                    { data: "stockoutAmount", title: "合计金额", width: "6em", className: "text-right", @*render: function (data, type, row, meta) { return "<div style='font-weight:bold' class='badge'>" + data + "</div>" }*@ },
                ]
        });

        detailTable = $('#details');
        detailTable.html($("<table></table>").dataTable().html());
        $('#orders.table').on('click', 'tbody td',   function() {
            var btn = $(this);
            var tr = $(this).closest('tr');
            tr.addClass('active').siblings().removeClass('active');
            var row = thisTable.row( tr );

            detailTable.html(buildOrderDetailTable(row.data()));

        });

        function buildOrderDetailTable(d) {
            var data;
            $.ajaxSettings.async = false;
            $.getJSON("@Url.Action("FahuoDetail")",{RCID:d.rcId},function(result){
                data = result
            })
            $.ajaxSettings.async = true;

            var container = $("<div><table id='details' class='table table-bordered table-subtable'></table></div>");
            var table = $("table",container);
            var datatable = table.dataTable({
                data: data,
                pageLength:50,
                columns:
                [
                    { data: "RN", title: "RN", width:"1em", className:"text-center" },
                    { data: "Id" , title: "编号", width:"8em", },
                    { data: "Description" , title: "描述", width:"auto", },
                    { data: "Size" , title: "规格", width:"10em", },
                    { data: "PCS", title: "片数", width:"8em", className:"text-right" },
                    { data: "Price" , title: "单价" , width:"8em", className:"text-right",},
                    { data: "ChargeUnit", title: "计价单位", width:"8em", className:"text-center" },
                    { data: "UnitQuantity" , title: "单位数量", width:"8em", className:"text-right", },
                    { data: "Amount" , title: "金额", width:"8em", className:"text-right text-primary", render:function(data, type, row, meta){return "<div style='font-weight:'>"+data+"</div>"}},
                ]
            });

            return table.html();
        }

        function filterGlobal () {
            thisTable.search(
                $('#filter').val(),
                false,true
            ).draw();
        }

        function filterColumn ( i ) {
            $('#example').DataTable().column( i ).search(
                $('#col'+i+'_filter').val(),
                $('#col'+i+'_regex').prop('checked'),
                $('#col'+i+'_smart').prop('checked')
            ).draw();
        }

        $(document).ready(function() {

            $('input#filter').on( 'keyup click', function () {
                filterGlobal();
            } );
        } );

        //var tmp = $("#orders");
        //tmp.wrap("<div class='panel panel-primary'></div>")
        //    .parent().prepend("<div class='panel-heading'>出库 - 主表</div>").css("margin-bottom", "10px") // panel
        //    .nextAll("div").wrapAll("<div class='row'></div>").each(function(index,Element){
        //        $(Element).wrap('<div class="col-xs-6"></div>')
        //    });
        //tmp.parent().parent().prepend('<div style="margin: 10px auto;"></div>');

    </script>
}
