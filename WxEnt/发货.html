<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="Assets/light7/dist/css/light7.min.css">

    <title>拼花大师™地板</title>

    <style>
        html {
            font-size: 20px !important;
        }

        .popup {
            background: #eee;
        }

        .row {
            text-align: center;
        }

            .row + .row {
                margin-top: 0.75rem;
            }
        /*
            .row > [class*=col-] {
                border: 1px solid #ddd;
                padding: .5rem;
            }
        */
        .icons-demo .icon {
            width: 2.5rem;
            height: 2.5rem;
            margin: 0.15rem;
            font-size: 1.2rem;
            line-height: 2.5rem;
            text-align: center;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 1.25rem;
            display: inline-block;
        }

        .icon ~ .tab-label {
            position: relative;
            top: .15rem;
            display: block;
            font-size: .75rem;
        }
    </style>

</head>
<body>

    <!-- page 容器 -->
    <div class="page page-current" id="main">
        <header class='bar-nav'>
            <div class="buttons-tab">
                <a href="#tab1" class="tab-link button active">单据流水</a>
                <a href="#tab2" class="tab-link button">客户列表</a>
                <a href="#tab3" class="tab-link button">开送货单</a>
            </div>
        </header>
        <!-- 这里是页面内容区 -->
        <div class="content">
            <div class="tabs">
                <div id="tab1" class="tab active">
                    <div class="list-block media-list inset">
                        <ul id="单据流水"></ul>

                    </div>
                </div>
                <div id="tab2" class="tab">
                    <div class="list-block inset">
                        <ul id="客户列表"></ul>
                    </div>
                </div>
                <div id="tab3" class="tab">

                    <div class="" id="开送货单">
                        <div class="list-block">
                            <ul>
                                <!-- Text inputs -->
                                <li>
                                    <div class="item-content">
                                        <div class="item-media"><i class="icon icon-form-email"></i></div>
                                        <div class="item-inner">
                                            <div class="item-title label">编号</div>
                                            <div class="item-input">
                                                <input type="text" id="id" placeholder="Your ID" onclick="{ $.popup('#popup客户列表')}" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content">
                                        <div class="item-media"><i class="icon icon-form-name"></i></div>
                                        <div class="item-inner">
                                            <div class="item-title label">名称</div>
                                            <div class="item-input">
                                                <input type="text" id="name" placeholder="Your Name" onclick="{ $.popup('#popup客户列表')}" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content">
                                        <div class="item-media"><i class="icon icon-form-toggle"></i></div>
                                        <div class="item-inner">
                                            <div class="item-title label">地址</div>
                                            <div class="item-input">
                                                <input type="text" id="address" placeholder="Your Address">
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- Date -->
                                <li>
                                    <div class="item-content">
                                        <div class="item-media"><i class="icon icon-form-calendar"></i></div>
                                        <div class="item-inner">
                                            <div class="item-title label">日期</div>
                                            <div class="item-input">
                                                <input type="date" id="thisdate" placeholder="Your Date">
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content">
                                        <div class="item-media"><i class="icon icon-form-comment"></i></div>
                                        <div class="item-inner">
                                            <div class="item-title label">备注</div>
                                            <div class="item-input">
                                                <input type="text" id="comment" placeholder="Your Comment">
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="list-block">
                        <ul>
                            <li><a href="#" class="item-link list-button" onclick="NewLi('#明细',this)">添加明细</a></li>
                        </ul>
                    </div>
                    <div class="list-block media-list inset">
                        <ul id="明细">

                        </ul>
                    </div>
                    <div class="content-block">
                        <div class="row">
                            <div class="col-50"><a href="#" class="button button-big button-fill button-danger close-popup" onclick="RemoveAll()">清空</a></div>
                            <div class="col-50"><a href="#" class="button button-big button-fill button-success close-popup" onclick="Save()">保存</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popups">
        <div class="popup" id="popup客户列表">
            <div class="list-block media-list inset">
                <ul id="客户列表2"></ul>
            </div>
        </div>
        <div class="popup" id="popup物料清单">
            <header class='bar bar-nav'>

                <a href='#' class='button button-link button-nav pull-left close-popup'>
                    <span class='icon icon-left'></span> 关闭
                </a>
                <button class="button button-link button-nav pull-right">
                    列表
                    <span class="icon icon-menu"></span>
                </button>
            </header>
            <div class="list-block media-list">
                <ul></ul>
                </div>
            </div>        
            <div class="popup" id="popup明细填表">
                <header class='bar bar-nav'>

                    <a href='#' class='button button-link button-nav pull-left close-popup'>
                        <span class='icon icon-left'></span> 关闭
                    </a>
                    <button class="button button-link button-nav pull-right">
                        列表
                        <span class="icon icon-menu"></span>
                    </button>
                </header>
                <div class="content">
                    <div id="index"></div>
                    <div class="content-block-title color-primary">物料属性</div>
                    <div class="list-block">
                        <ul>
                            <li>
                            <div class="item-content">
                                <div class="item-media"><i class="icon icon-form-name"></i></div>
                                <div class="item-inner">
                                    <div class="item-title label">编号</div>
                                    <div class="item-input">
                                        <input id="recordid" type="text" placeholder="Type" value="微信登记" readonly>
                                    </div>
                                </div>
                            </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="icon icon-form-name"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title label">描述</div>
                                        <div class="item-input">
                                            <input id="recordname" type="text" placeholder="Description">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="icon icon-form-gender"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title label">规格</div>
                                        <div class="item-input">
                                            <select id="recordguige" onchange="Compute()">
                                                <option>450*450*15</option>
                                                <option>500*500*15</option>
                                                <option>600*600*15</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="icon icon-form-email"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title label">片数</div>
                                        <div class="item-input">
                                            <input type="text" id="recordpianshu" placeholder="PCS" onchange="Compute()">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="icon icon-form-email"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title label">单位数量</div>
                                        <div class="item-input">
                                            <input type="text" id="recorddanweishuliang" placeholder="Compute" readonly">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="icon icon-form-gender"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title label">计价单位</div>
                                        <div class="item-input">
                                            <select id="recordjijiadanwei" onchange="Compute()">
                                                <option>平方米</option>
                                                <option>延长米</option>
                                                <option>套</option>
                                                <option>片</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="icon icon-form-gender"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title label">单价</div>
                                        <div class="item-input">
                                            <input type="text" id="recorddanjia" placeholder="Price" onchange="Compute()">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media"><i class="icon icon-form-gender"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title label">金额</div>
                                        <div class="item-input">
                                            <input type="text" id="recordjine" placeholder="Amount" readonly>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="content-block">
                        <div class="row">
                            <div class="col-50"><a href="#" class="button button-big button-fill button-danger close-popup">Cancel</a></div>
                            <div class="col-50"><a href="#" class="button button-big button-fill button-success" onclick="RecordSubmit()">Submit</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <div class='popups_单据流水'>
        <div class='popup' id='单据明细'>
            <header class='bar bar-nav'>
                <h1 class='title'>单据明细</h1>
                <a href='#' class='button button-link button-nav pull-left close-popup'>
                    <span class='icon icon-left'></span> 关闭
                </a>
            </header>
            
            <div class='content'>
                <div id="smalltitle" class='content-block-title'></div>
                <div class='list-block media-list inset'>
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>

    <div class='popups_单位信息'>

    </div>
    <div class="popups_发货明细">
        <div class='popup' id='发货单'>
            <header class='bar bar-nav'>
                <h1 class='title'>单据列表</h1>
                <a href='#' class='button button-link button-nav pull-left close-popup'>
                    <span class='icon icon-left'></span> 关闭
                </a>
            </header>
            <nav class="bar bar-tab">
                <a class="tab-item" href="#" onclick="{ window.行号 -= window.每页行数; if (window.行号 < 0) window.行号 = 0; 获取发货清单(window.单位编号); }">
                    <span class="icon icon-left"></span>
                    <span class="tab-label">往前</span>
                </a>
                <a class="tab-item active" href="#" onclick="{ window.行号 = 0; 获取发货清单(window.单位编号); }">
                    <span class="icon icon-home"></span>
                    <span class="tab-label">首页</span>
                </a>
                <a class="tab-item" href="#" onclick="{ if (window.行号 < window.总行数 - window.每页行数) window.行号 += window.每页行数; 获取发货清单(window.单位编号); }">
                    <span class="icon icon-right"></span>
                    <span class="tab-label">往后</span>
                </a>
            </nav>
            <div class='content'>
                <div class='content-block-title'>拼花大师地板 KH-13-0032</div>
                <div class='card'>
                    <div class='card-header'>单号：SH-1603-005</div>
                    <div class='card-content'>
                        <div class='list-block media-list'>
                            <ul>
                                <li class='item-content item-link'>
                                    <div class='item-media'>
                                        <img src='/Assets/pic1.jpg' width='80'>
                                    </div>
                                    <div class='item-inner'>
                                        <div class='item-title-row'>
                                            <div class='item-title'>名称</div>
                                        </div>
                                        <div class='item-subtitle'>拼花大师地板</div>
                                        <div class='item-title-row'>
                                            <div class='item-title'>地址</div>
                                        </div>
                                        <div class='item-subtitle'>浙江省嘉善县开发区玉山路8号</div>

                                        <div class='item-title-row'>
                                            <div class='item-title'>统计</div>
                                        </div>
                                        <div class='item-title-row'>
                                            <div class='item-subtitle'>平方</div>
                                            <div class='item-subtitle color-primary'>2387.00</div>
                                        </div>
                                        <div class='item-title-row'>
                                            <div class='item-subtitle'>金额</div>
                                            <div class='item-subtitle color-primary'>238793.00</div>
                                        </div>

                                        <div class='item-title-row'><div class='item-title'>摘要</div></div>
                                        <div class='item-title-row'>
                                            <div class='item-subtitle'>榆木 拼花素板</div>
                                            <div class='item-subtitle'>1005片</div>
                                        </div>
                                        <div class='item-title-row'>
                                            <div class='item-subtitle'>柞木 拼花素板</div>
                                            <div class='item-subtitle'>870片</div>
                                        </div>
                                        <div class='item-title-row'>
                                            <div class='item-subtitle'>安然盛世 拼花</div>
                                            <div class='item-subtitle'>206片</div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class='card-footer'>
                        <span>单据日期：2016-03-17</span>
                        <span>点击查看</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="pages"></div>

    <script type='text/javascript' src='Scripts/jquery-2.2.2.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='Assets/light7/dist/js/light7.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='Assets/light7/dist/js/i18n/cn.min.js' charset='utf-8'></script>
    <script type='text/javascript'>
        // 对Date的扩展，将 Date 转化为指定格式的String
        // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
        // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
        // 例子：
        // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
        // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1,                 //月份
                "d+": this.getDate(),                    //日
                "h+": this.getHours(),                   //小时
                "m+": this.getMinutes(),                 //分
                "s+": this.getSeconds(),                 //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds()             //毫秒
            };
            if (/(y+)/.test(fmt))
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt))
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }

        function getNow() {
            var date = new Date();
            return date.Format("yyyy-MM-dd");
        }
        $("#开送货单 input[type=date]").val(getNow());

    </script>
    <script type="text/javascript">
        function 往来单位() {
            this.数据 = this.获取数据();
        }
        往来单位.prototype.获取数据 = function () {
            var retdata;
            $.ajax({
                url: "发货.ashx?行为=往来单位",
                dataType: "json",
                async: false,
                success: function (data) {
                    retdata = data;
                }
            })
            return retdata;
        };
        往来单位.prototype.生成往来单位列表 = function (selector) {
            var data = $往来单位.数据;
            var htmlstring = "";
            //htmlstring += "<header class='bar bar-nav'>";
            //htmlstring += "<h1 class='title'>单位信息</h1>";
            //htmlstring += "<a href='#' class='button button-link button-nav pull-left close-popup'>";
            //htmlstring += "<span class='icon icon-left'></span> 关闭"
            //htmlstring += "</a>"
            //htmlstring += "</header>"
            if (data == '' || data == undefined || data == null) {
                htmlstring += "<li class='item-content item-link'>";
                htmlstring += "<div class='item-media'><i class='icon icon-f7'></i></div>";
                htmlstring += "<div class='item-inner'>";
                htmlstring += "<div class='item-title'>" + "加载失败" + "</div>";
                htmlstring += "</div>";
                htmlstring += "</li>";
                $(selector).html(s);
            } else {
                for (var i in data) {
                    htmlstring += "<li class='item-content item-link close-popup' id='" + data[i].单位编号 + "'>";
                    htmlstring += "<div class='item-media'><i class='icon icon-f7'></i></div>";
                    htmlstring += "<div class='item-inner'>";
                    htmlstring += "<div class='item-title'>" + data[i].单位名称 + "</div>";
                    //htmlstring+= "<div class='item-after'><span class='color-primary'>" + data[i].单位编号 + "</span></div>";
                    htmlstring += "</div>";
                    htmlstring += "</li>";
                }
                $(selector).html(htmlstring);
            }
            return $(selector);
        }

        往来单位.prototype.生成往来单位信息 = function (selector) {
            var data = $往来单位.数据;
            var htmlstring = "";
            for (var i in data) {
                htmlstring += "<div class='popup popup-" + data[i].单位编号 + "'>";
                htmlstring += "<header class='bar bar-nav'>";
                htmlstring += "<h1 class='title'>单位信息</h1>";
                htmlstring += "<a href='#' class='button button-link button-nav pull-left close-popup'>";
                htmlstring += "<span class='icon icon-left'></span> 关闭"
                htmlstring += "</a>"
                htmlstring += "</header>"
                htmlstring += "<div class='content'>"
                htmlstring += "<div class='list-block'>"
                htmlstring += "<ul>"
                htmlstring += "<li>"
                htmlstring += "<div class='item-content'>"
                htmlstring += "<div class='item-media'><i class='icon icon-form-email'></i></div>"
                htmlstring += "<div class='item-inner'>"
                htmlstring += "<div class='item-title label'>单位编号</div>"
                htmlstring += "<div class='item-input'>"
                htmlstring += "<input type='text' placeholder='未登记' value='" + data[i].单位编号 + "' readonly>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</li>"
                htmlstring += "<li>"
                htmlstring += "<div class='item-content'>"
                htmlstring += "<div class='item-media'><i class='icon icon-form-name'></i></div>"
                htmlstring += "<div class='item-inner'>"
                htmlstring += "<div class='item-title label'>单位名称</div>"
                htmlstring += "<div class='item-input'>"
                htmlstring += "<input type='text' placeholder='未登记' value='" + data[i].单位名称 + "' readonly>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</li>"
                htmlstring += "<li>"
                htmlstring += "<div class='item-content'>"
                htmlstring += "<div class='item-media'><i class='icon icon-form-password'></i></div>"
                htmlstring += "<div class='item-inner'>"
                htmlstring += "<div class='item-title label'>优先级</div>"
                htmlstring += "<div class='item-input'>"
                htmlstring += "<input type='text' placeholder='未登记' value='" + data[i].RANK + "' readonly>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</li>"
                htmlstring += "<li>"
                htmlstring += "<div class='item-content'>"
                htmlstring += "<div class='item-media'><i class='icon icon-form-tel'></i></div>"
                htmlstring += "<div class='item-inner'>"
                htmlstring += "<div class='item-title label'>电话</div>"
                htmlstring += "<div class='item-input'>"
                htmlstring += "<input type='text' placeholder='未登记' value='" + data[i].电话 + "' readonly>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</li>"
                htmlstring += "<li>"
                htmlstring += "<div class='item-content'>"
                htmlstring += "<div class='item-media'><i class='icon icon-form-url'></i></div>"
                htmlstring += "<div class='item-inner'>"
                htmlstring += "<div class='item-title label'>传真</div>"
                htmlstring += "<div class='item-input'>"
                htmlstring += "<input type='text' placeholder='未登记' value='" + data[i].传真 + "' readonly>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</li>"
                htmlstring += "<li class='align-top'>"
                htmlstring += "<div class='item-content'>"
                htmlstring += "<div class='item-media'><i class='icon icon-form-comment'></i></div>"
                htmlstring += "<div class='item-inner'>"
                htmlstring += "<div class='item-title label'>地址</div>"
                htmlstring += "<div class='item-input'>"
                htmlstring += "<textarea readonly>" + data[i].单位地址 + "</textarea>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</li>"
                htmlstring += "<li class='align-top'>"
                htmlstring += "<div class='item-content'>"
                htmlstring += "<div class='item-media'><i class='icon icon-form-comment'></i></div>"
                htmlstring += "<div class='item-inner'>"
                htmlstring += "<div class='item-title label'>备注</div>"
                htmlstring += "<div class='item-input'>"
                htmlstring += "<textarea readonly></textarea>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</li>"
                htmlstring += "</ul>"
                htmlstring += "</div>"
                htmlstring += "</div>"
                htmlstring += "</div>"
            }

            $(selector).html(htmlstring);
            return $(selector);
        };

        var $往来单位 = new 往来单位;
        $往来单位.生成往来单位列表("#客户列表").find("li").click(function () {
            $.actions(BuildActionsGroup(this.id, $(this).find(".item-title").text()));
        });
        $往来单位.生成往来单位列表("#客户列表2").find("li").click(function () {
            var data = { id: this.id, name: $(this).find(".item-title").text() };
            $("#开送货单 #id").val(data.id);
            $("#开送货单 #name").val(data.name);
            return data;
        });
        $往来单位.生成往来单位信息(".popups_单位信息");

        // 全局变量

        var 行号 = 0;
        var 总行数 = 0;
        var 单位编号 = "";
        var 每页行数 = 10;

        function 获取发货清单(id, name) {
            $("#发货单 .content").html("");
            $("#发货单 .title").text(name);
            $.ajax({
                url: "发货.ashx?行为=发货明细&单位编号=" + id + "&行号=" + window.行号,
                dataType: "json",
                success: function (data) {

                    window.总行数 = data.总行数;
                    var s = "";
                    for (var i in data.单据信息) {
                        s += "<div class='content-block-title'>" + data.单据信息[i].rn + "＃" + "</div>"
                        s += "<div class='card'>"
                        s += "<div class='card-header'>"
                        s += "<span>单号：" + data.单据信息[i].送货单号 + "</span>"
                        //s += "<span>日期：" + data.单据信息[i].送货日期 + "</span>"
                        s += "</div>"
                        s += "<div class='card-content'>"
                        s += "<div class='list-block media-list'>"
                        s += "<ul>"
                        s += "<li class='item-content'>"
                        s += "<div class='item-media'>"
                        s += "<img src='/Assets/pic1.jpg' width='80'>"
                        s += "</div>"
                        s += "<div class='item-inner'>"
                        //s += "<div class='item-title-row'>"
                        //s += "<div class='item-title'>名称：</div>"
                        //s += "</div>"
                        //s += "<div class='item-subtitle'>" + data.单据信息[i].客户 + "</div>"

                        //s += "<div class='item-title-row'>"
                        //s += "<div class='item-title'>地址：</div>"
                        //s += "</div>"
                        //s += "<div class='item-subtitle'>"+data.单据信息[i].地址+"</div>"

                        s += "<div class='item-title-row'><div class='item-title'>摘要：</div></div>"
                        for (var j in data.发货明细) {
                            if (data.发货明细[j].ExcelServerRCID == data.单据信息[i].ExcelServerRCID) {
                                s += "<div class='item-title-row'>"
                                s += "<div class='item-subtitle'>" + data.发货明细[j].描述 + "</div>"
                                s += "<div class='item-subtitle'>" + data.发货明细[j].PCS + " P</div>"
                                s += "</div>"
                            }
                        }

                        s += "<div class='item-title-row'>"
                        s += "<div class='item-title'>统计：</div>"
                        s += "</div>"
                        s += "<div class='item-title-row'>"
                        s += "<div class='item-subtitle'>平方</div>"
                        s += "<div class='item-subtitle color-primary'>" + data.单据信息[i].square + "</div>"
                        s += "</div>"
                        s += "<div class='item-title-row'>"
                        s += "<div class='item-subtitle'>金额</div>"
                        s += "<div class='item-subtitle color-primary'>" + data.单据信息[i].total + "</div>"
                        s += "</div>"

                        s += "</div>"
                        s += "</li>"
                        s += "</ul>"
                        s += "</div>"
                        s += "</div>"
                        s += "<div class='card-footer'>"
                        s += "<span>单据日期：" + data.单据信息[i].送货日期 + "</span>"
                        s += "<a href='#' class='link'>查看详情</a>"
                        s += "</div>"
                        s += "</div>"
                    }
                    $("#发货单 .content").html(s);
                }
            })

        }

        var $Orders = new Object();
        $Orders.操作对象 = $("#单据流水");
        $Orders.每页行数 = 20;
        $Orders.页号 = 1;
        $Orders.开始行号 = 0;
        $Orders.绑定点击事件 = function () {
            $Orders.操作对象.find("li").click(function () {
                $.popup("#单据明细")
                var ss = "<div class='color-primary'>";
                ss += "<b>";
                ss += $(this).find(".item-title-row").eq(0).find(".item-title").text(); //客户名称
                ss += " / ";
                ss += $(this).find(".item-title-row").eq(1).find(".item-subtitle").eq(0).text(); //单号
                ss += " / ";
                ss += $(this).find(".item-title-row").eq(1).find(".item-subtitle").eq(1).text(); //日期
                ss += "<br>";
                ss += "<br>";
                ss += "金额：" + $(this).find(".item-title-row").eq(2).find(".item-subtitle").eq(1).text(); //金额
                ss += "<br>";
                ss += "<br>";
                ss += "</b>";
                ss += "</div>";
                $("#单据明细 #smalltitle").html(ss)
                var s1 = "&rcid=" + this.id;

                $.ajax({
                    url: "发货.ashx?行为=单据流水_单据明细" + s1,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        var htmlstring = "";
                        for (var v in data) {
                            htmlstring += "<li>"
                            htmlstring += "<a href='#' class='item-link item-content'>"
                            htmlstring += "<div class='item-inner'>"
                            htmlstring += "<div class='item-title-row'>"
                            htmlstring += "<div class='item-title'>" + data[v].ExcelServerRN + "＃ " + data[v].描述 + "</div>"
                            htmlstring += "<div class='item-subtitle'>" + data[v].编号 + "</div>"
                            htmlstring += "</div>"
                            htmlstring += "<div class='item-subtitle'>数量：" + data[v].PCS + " 片（" + data[v].单位数量 + " " + data[v].计价单位 + "）</div>"
                            htmlstring += "<div class='item-subtitle'>单价：" + data[v].单价 + " 元/" + data[v].计价单位 + "</div>"
                            htmlstring += "<div class='item-subtitle'>金额：" + data[v].金额 + " 元</div>"
                            htmlstring += "<div class='item-title-row'>"
                            htmlstring += "<div class='item-subtitle'></div>"
                            htmlstring += "</div>"
                            htmlstring += "<div class='item-text'>木种：" + data[v].木种 + "，工艺：" + data[v].工艺 + "</div>"
                            htmlstring += "</div>"
                            htmlstring += "</a>"
                            htmlstring += "</li>"
                        }
                        $("#单据明细").find("ul").html(htmlstring);

                    }
                })
            });
            return this;
        }
        $Orders.构造单据流水列表 = function (selector) {
            if (selector != null)
                this.操作对象 = $(selector);
            var s1 = "&每页行数=" + this.每页行数;
            var s2 = "&开始行号=" + this.开始行号;
            $.ajax({
                url: "发货.ashx?行为=单据流水" + s1 + s2,
                dataType: "json",
                async: false,
                success: function (data) {
                    var htmlstring = "";
                    for (var i in data) {
                        htmlstring += "<li class='item-content item-link' id='" + data[i].ExcelServerRCID + "'>";
                        htmlstring += "<div class='item-media'><i class='icon icon-f7'></i></div>";
                        htmlstring += "<div class='item-inner'>"
                        htmlstring += "<div class='item-title-row'>"
                        htmlstring += "<div class='item-title'>" + data[i].客户 + "</div>"
                        htmlstring += "<div class='item-subtitle'>" + data[i].业务描述 + "</div>"
                        htmlstring += "</div>"
                        htmlstring += "<div class='item-title-row'>"
                        htmlstring += "<div class='item-subtitle'>" + data[i].送货单号 + "</div>"
                        htmlstring += "<div class='item-subtitle'>" + data[i].送货日期 + "</div>"
                        htmlstring += "</div>"
                        htmlstring += "<div class='item-title-row'>"
                        htmlstring += "<div class='item-subtitle'>" + data[i].项目数 + "</div>"
                        htmlstring += "<div class='item-subtitle'><span class='color-primary'>" + data[i].金额 + "</span></div>"
                        htmlstring += "</div>"
                        htmlstring += "</li>";
                    }
                    $Orders.操作对象.html(htmlstring);
                }
            });
            return this;
        }
        $Orders.构造单据流水列表().绑定点击事件();

    </script>
    <script type="text/javascript">

        function BuildActionsGroup(id, name) {
            var buttons1 = [{
                text: name + "（" + id + "）",
                label: true
            },
            {
                text: '单位信息',
                //bold: true,
                color: 'primary',
                onClick: function () {
                    $.popup(".popup-" + id)
                }
            },
            {
                text: '发货明细',
                //bold: true,
                color: 'warning',
                onClick: function () {
                    window.单位编号 = id;
                    window.行号 = 0;
                    获取发货清单(id, name);
                    $.popup("#发货单");
                }
            }
            ];
            var buttons2 = [{
                text: '取消',
                bg: 'danger'
            }
            ];
            var groups = [buttons1, buttons2];
            return groups;
        }
        function BuildActionsGroupForDetails(title,obj) {
            var buttons1 = [{
                text: title,
                label: true
            },
            {
                text: '编辑',
                //bold: true,
                color: 'primary',
                onClick: function () {
                    $('#popup明细填表 #index').attr('data-index', $(obj).index());

                    recordid.value = $(obj).find('#lirecordid').text() || "微信登记";
                    recordname.value = $(obj).find('#lirecordname').text() || "";
                    recordguige.value = $(obj).find('#lirecordguige').text() || "";
                    recordpianshu.value = $(obj).find('#lirecordpianshu').text() || "";
                    recorddanweishuliang.value = $(obj).find('#lirecorddanweishuliang').text() || "";
                    recordjijiadanwei.value = $(obj).find('#lirecordjijiadanwei').text() || "";
                    recorddanjia.value = $(obj).find('#lirecorddanjia').text() || "";
                    recordjine.value = $(obj).find('#lirecordjine').text() || "";

                    $.popup('#popup明细填表');
                    $('#popup明细填表 .icon-menu').parent().click(function () {
                        $.ajax({
                            url: "发货.ashx?行为=物料清单",
                            dataType: "json",
                            success: function (data) {
                                var htmlstring = "";
                                for (var i in data) {
                                    htmlstring += "<li class='item-link'>";
                                    htmlstring += "<div class='item-content'>";
                                    htmlstring += "<div class='item-media'>" + i + "</div>";
                                    htmlstring += "<div class='item-inner'>" + data[i].描述;
                                    htmlstring += "</div>";
                                    htmlstring += "</div>";
                                    htmlstring += "</li>";
                                }
                                $('#popup物料清单 ul').html(htmlstring);
                                $.popup('#popup物料清单');
                            }
                        })
                    })
                }
            },
            {
                text: '删除',
                //bold: true,
                color: 'warning',
                onClick: function () {
                    var p = $(obj).parent();
                    $(obj).remove();
                    p.find("li").each(function (index, element) {
                        $(element).find(".item-title-row:eq(0) .item-title:eq(0) span:eq(0)").text("№" + (index + 1) + ".");
                    })
                }
            }
            ];
            var buttons2 = [{
                text: '取消',
                bg: 'danger'
            }
            ];
            var groups = [buttons1, buttons2];
            return groups;
        }

        function NewLi(selector,obj)
        {
            var htmlstring = "";
            htmlstring += "<li class='item-link'>";
            htmlstring += "<div class='item-content'>";
            htmlstring += "<div class='item-inner'>";
            htmlstring += "<div class='item-title-row'>"
            htmlstring += "<div class='item-title'><span></span><span></span></div>"
            htmlstring += "</div>"
            htmlstring += "</div>";
            htmlstring += "</div>";
            htmlstring += "</li>";
            $(selector).append(htmlstring);
            $(selector).find("li").each(function (index,element) {
                $(element).find(".item-title-row:eq(0) .item-title:eq(0) span:eq(0)").text("№" + (index + 1) + ".");
            })
            $(selector).off('click', 'li').on('click', 'li', function (event) { $.actions(BuildActionsGroupForDetails('№' + ($(this).index() + 1), this));});
        }

        function Compute()
        {
            var arr = recordguige.value.split("*");
            var l = parseFloat(arr[0] || 0);
            var w = parseFloat(arr[1] || 0);
            var h = parseFloat(arr[2] || 0);
            var pcs = parseFloat(recordpianshu.value || 0);

            recorddanweishuliang.value = (l / 1000 * w / 1000 * pcs).toFixed(2);
            recordjine.value = ((l / 1000 * w / 1000 * pcs) * (recorddanjia.value || 0)).toFixed(2);
        }

        function RecordSubmit()
        {
            //$.ajax({
            //    url: "发货.ashx?行为=提交送货单",
            //    type: "post",
            //    dataType: "json",
            //    data: {
            //        recordid: recordid.value,
            //        recordname: recordname.value,
            //        recordguige: recordguige.value,
            //        recordpianshu: recordpianshu.value,
            //        recorddanweishuliang: recorddanweishuliang.value,
            //        recordjijiadanwei: recordjijiadanwei.value,
            //        recorddanjia: recorddanjia.value,
            //        recordjine: recordjine.value
            //    }
            //})

            var data = {
                index: $("#popup明细填表 #index").attr("data-index"),
                recordid: recordid.value,
                recordname: recordname.value,
                recordguige: recordguige.value,
                recordpianshu: recordpianshu.value,
                recorddanweishuliang: recorddanweishuliang.value,
                recordjijiadanwei: recordjijiadanwei.value,
                recorddanjia: recorddanjia.value,
                recordjine: recordjine.value
            };

            if (!data.recordid ||
                !data.recordname ||
                !data.recordguige ||
                !data.recordpianshu ||
                !data.recorddanweishuliang ||
                !data.recordjijiadanwei ||
                !data.recorddanjia ||
                !data.recordjine)
            {
                alert("填写不完整");
                return;
            }

            var target = $("#明细 li").eq(data.index).find(".item-inner");
            
            var htmlstring = "";
            htmlstring += "<div class='item-title-row'>"
            htmlstring += "<div class='item-title'><span>" + "№" + (parseInt(data.index) + 1) + ".</span><span id='lirecordname'>" + data.recordname + "</span></div>"
            htmlstring += "<div class='item-subtitle' id='lirecordid'>" + data.recordid + "</div>"
            htmlstring += "</div>"
            htmlstring += "<div class='item-title-row'>"
            htmlstring += "<div class='item-subtitle'>规格</div>"
            htmlstring += "<div class='item-subtitle' id='lirecordguige'>" + data.recordguige + "</div>"
            htmlstring += "</div>"
            htmlstring += "<div class='item-title-row'>"
            htmlstring += "<div class='item-subtitle'>数量</div>"
            htmlstring += "<div class='item-subtitle'><span id='lirecordpianshu'>" + data.recordpianshu + "</span>"+" 片｜" + "<span id='lirecorddanweishuliang'>"+data.recorddanweishuliang+"</span>" + " " + "<span id='lirecordjijiadanwei'>"+data.recordjijiadanwei+"</span>" + "</div>"
            htmlstring += "</div>"
            htmlstring += "<div class='item-title-row'>"
            htmlstring += "<div class='item-subtitle'>单价</div>"
            htmlstring += "<div class='item-subtitle'>" + "<span id='lirecorddanjia'>" + data.recorddanjia + "</span>" + " 元" + "</div>"
            htmlstring += "</div>"
            htmlstring += "<div class='item-title-row'>"
            htmlstring += "<div class='item-subtitle'>金额</div>"
            htmlstring += "<div class='item-subtitle'>" + "<span id='lirecordjine'>" + data.recordjine + "</span>" + " 元" + "</div>"
            htmlstring += "</div>"

            target.html(htmlstring);
            $.closeModal();
        }

        function Save()
        {
            if ($("#明细 li").length == 0)
                return;
            
            var details = new Array();
            
            $('#明细 li').each(function (index, element) {
                if (!$(element).find('#lirecordname').text())
                    return true; // continue 如果记录为空，跳过这一条

                details.push({
                    index: index,
                    recordid: $(element).find('#lirecordid').text(),
                    recordname: $(element).find('#lirecordname').text(),
                    recordguige: $(element).find('#lirecordguige').text(),
                    recordpianshu: $(element).find('#lirecordpianshu').text(),
                    recorddanweishuliang: $(element).find('#lirecorddanweishuliang').text(),
                    recordjijiadanwei: $(element).find('#lirecordjijiadanwei').text(),
                    recorddanjia: $(element).find('#lirecorddanjia').text(),
                    recordjine: $(element).find('#lirecordjine').text(),
                })
            })
            if (details.length < 1) {
                alert("操作失败，请至少保证一条有效的明细。");
                return false;
            }
            
            var data =
                {
                    id: $('#开送货单 #id').val(),
                    name: $('#开送货单 #name').val(),
                    address: $('#开送货单 #address').val(),
                    thisdate: $('#开送货单 #thisdate').val(),
                    comment: $('#开送货单 #comment').val(),
                    details: details
                }
            
            $.ajax({
                url: "发货.ashx?行为=提交送货单",
                type: "post",
                dataType: "json",
                data: JSON.stringify(data),
                success:function(data)
                {
                    
                }
            })
        }

        function RemoveAll()
        {
            $.confirm("确定清空明细吗？", function () {$("#明细").empty() })
        }
    </script>
    <script type='text/javascript'>
    </script>
</body>
</html>
